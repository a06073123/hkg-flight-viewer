# Daily Flight Data Archive to Cloudflare D1
# Runs daily to keep historical data up to date
# Uses rolling re-archive strategy to capture delayed flight final status
name: Archive Flights

on:
  schedule:
    # Run at 16:00 UTC (00:00 HKT next day)
    - cron: "0 16 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "Date to archive (YYYY-MM-DD), leave empty for rolling archive"
        required: false
        type: string
      rolling_days:
        description: "Number of past days to re-archive (default: 6, covers up to +5 day delays)"
        required: false
        type: number
        default: 6

jobs:
  archive:
    name: Archive Flight Data to D1
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Archive flights to D1 (rolling strategy)
        env:
          TZ: Asia/Hong_Kong
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            # Manual single date archive
            echo "ðŸ“¦ Archiving ${{ inputs.date }} to D1..."
            npm run archive -- ${{ inputs.date }}
          else
            # Rolling archive: D-1 through D-N to capture delayed flight updates
            # Data analysis shows max delay is +5 days, so default is 6 days
            # Uses HKT timezone for date calculation (cron runs at 00:00 HKT)
            ROLLING_DAYS=${{ inputs.rolling_days || 6 }}
            echo "ðŸ”„ Rolling archive for past $ROLLING_DAYS days (HKT timezone)..."
            echo "ðŸ“… Current HKT time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
            
            for i in $(seq 1 $ROLLING_DAYS); do
              DATE=$(date -d "-${i} day" +%Y-%m-%d)
              echo ""
              echo "ðŸ“¦ Archiving $DATE (D-$i) to D1..."
              npm run archive -- $DATE
              
              # Rate limiting: 3 second delay between archive runs
              if [ $i -lt $ROLLING_DAYS ]; then
                sleep 3
              fi
            done
            
            echo ""
            echo "âœ… Rolling archive complete - data written to Cloudflare D1"
          fi
